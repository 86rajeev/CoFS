/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(e,t){if("function"==typeof define&&define.amd)define(["async","buffer","eventemitter2"],t);else{var n=e.CoFS;e.CoFS=t(e.async,e.buffer,e.EventEmitter2),e.CoFS.noConflict=function(){return e.CoFS=n,CoFS}}}(this,function(e,t,n){var r,i,o;return function(e){function t(e,t){return _.call(e,t)}function n(e,t){var n,r,i,o,s,u,f,l,c,a,p,d=t&&t.split("/"),h=v.map,g=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(d=d.slice(0,d.length-1),e=e.split("/"),s=e.length-1,v.nodeIdCompat&&F.test(e[s])&&(e[s]=e[s].replace(F,"")),e=d.concat(e),c=0;c<e.length;c+=1)if(p=e[c],"."===p)e.splice(c,1),c-=1;else if(".."===p){if(1===c&&(".."===e[2]||".."===e[0]))break;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((d||g)&&h){for(n=e.split("/"),c=n.length;c>0;c-=1){if(r=n.slice(0,c).join("/"),d)for(a=d.length;a>0;a-=1)if(i=h[d.slice(0,a).join("/")],i&&(i=i[r])){o=i,u=c;break}if(o)break;!f&&g&&g[r]&&(f=g[r],l=c)}!o&&f&&(o=f,u=l),o&&(n.splice(0,u,o),e=n.join("/"))}return e}function s(t,n){return function(){var r=b.call(arguments,0);return"string"!=typeof r[0]&&1===r.length&&r.push(null),d.apply(e,r.concat([t,n]))}}function u(e){return function(t){return n(t,e)}}function f(e){return function(t){y[e]=t}}function l(n){if(t(m,n)){var r=m[n];delete m[n],w[n]=!0,p.apply(e,r)}if(!t(y,n)&&!t(w,n))throw new Error("No "+n);return y[n]}function c(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function a(e){return function(){return v&&v.config&&v.config[e]||{}}}var p,d,h,g,y={},m={},v={},w={},_=Object.prototype.hasOwnProperty,b=[].slice,F=/\.js$/;h=function(e,t){var r,i=c(e),o=i[0];return e=i[1],o&&(o=n(o,t),r=l(o)),o?e=r&&r.normalize?r.normalize(e,u(t)):n(e,t):(e=n(e,t),i=c(e),o=i[0],e=i[1],o&&(r=l(o))),{f:o?o+"!"+e:e,n:e,pr:o,p:r}},g={require:function(e){return s(e)},exports:function(e){var t=y[e];return"undefined"!=typeof t?t:y[e]={}},module:function(e){return{id:e,uri:"",exports:y[e],config:a(e)}}},p=function(n,r,i,o){var u,c,a,p,d,v,_=[],b=typeof i;if(o=o||n,"undefined"===b||"function"===b){for(r=!r.length&&i.length?["require","exports","module"]:r,d=0;d<r.length;d+=1)if(p=h(r[d],o),c=p.f,"require"===c)_[d]=g.require(n);else if("exports"===c)_[d]=g.exports(n),v=!0;else if("module"===c)u=_[d]=g.module(n);else if(t(y,c)||t(m,c)||t(w,c))_[d]=l(c);else{if(!p.p)throw new Error(n+" missing "+c);p.p.load(p.n,s(o,!0),f(c),{}),_[d]=y[c]}a=i?i.apply(y[n],_):void 0,n&&(u&&u.exports!==e&&u.exports!==y[n]?y[n]=u.exports:a===e&&v||(y[n]=a))}else n&&(y[n]=i)},r=i=d=function(t,n,r,i,o){if("string"==typeof t)return g[t]?g[t](n):l(h(t,n).f);if(!t.splice){if(v=t,v.deps&&d(v.deps,v.callback),!n)return;n.splice?(t=n,n=r,r=null):t=e}return n=n||function(){},"function"==typeof r&&(r=i,i=o),i?p(e,t,n,r):setTimeout(function(){p(e,t,n,r)},4),d},d.config=function(e){return d(e)},r._defined=y,o=function(e,n,r){n.splice||(r=n,n=[]),t(y,e)||t(m,e)||(m[e]=[e,n,r])},o.amd={jQuery:!0}}(),o("node_modules/almond/almond",function(){}),o("cofs/array2buffer",["buffer"],function(e){"use stricts";var t=e.Buffer,n=function(e){var n,r,i,o,s;if(s=new Int8Array(e),o=new t(s),i=e.byteLength,o.length||!i)return s=null,o;for(o=new t(i),n=0;i>n;n++)r=s[n],o.writeUInt8(r,n);return s=null,o};return n}),o("cofs/promise",[],function(){"use stricts";var e=function(e){if("function"!=typeof e)throw new Error("Listener not defined");return function(){var t=Array.prototype.slice.call(arguments);e.apply({},t)}};return e}),o("cofs/readstream",["async","eventemitter2"],function(e,t){"use stricts";var n,r,i=function(){Error.call(this)};i.prototype=new Error;var o=function(){this.initialize.apply(this,arguments)};return o.prototype=new t,o.prototype.initialize=function(e,i,o){if(t.call(this),o=o||{},n=window.File||void 0,r=window.Blob||void 0,"undefined"==typeof n)throw new Error("File componet does not exits");if("undefined"==typeof r)throw new Error("Blob componet does not exists");if(this._fs=e,this._file=i,this._blockSize=o.blockSize||4096,this._start=o.start||0,this._end=void 0!==o.end?o.end:void 0,this._paused=!1,this._stoped=!1,this._end<=this._start)throw new Error("Start byte has been bigger that end byte")},o.prototype._error=function(e){var t=this.emit("error",e);if(!t)throw e},o.prototype.getFile=function(e){var t=this._fs,i=this._file;return i instanceof n||i instanceof r?e(void 0,i):void t.getFileEntry(i,function(t,n){return t?e(t):void n.file(function(t){return e(void 0,t)})})},o.prototype.start=function(){var t=this,n=this._start,r=this._end,o=this._blockSize;this.getFile(function(s,u){if(s)return t._error(s);t.emit("debug","Starting strean for "+u.fullPath),"undefined"==typeof r&&(r=u.size);var f=n;e.whilst(function(){return r>=f},function(e){var n=function(n){return t.emit("debug","Sending data block"),t.emit("data",n),e()};t._fs.readFilePart(u,f,f+o,function(r,s){return f+=o,r?void e(r):t._paused?(t.emit("debug","Is paused, wating resume event to send data"),t.once("resume",function(){t.emit("resumed, sending data"),n(s)})):t._stoped?(t.emit("Is stoped, throwing"),e(new i)):void n(s)})},function(e){return e instanceof i?void 0:e?t._error(e):(t.emit("Finished"),t._paused?(t.emit("Are finished but is paused, waiting."),void t.once("resume",function(){return t.emit("debug","resumed, sending finish"),t.emit("finish")})):(t.emit("Sending finish"),t.emit("finish")))})})},o.prototype.pause=function(){this._paused=!0,this.emit("pause")},o.prototype.resume=function(){this._paused=!1,this.emit("resume")},o.prototype.stop=function(){this._stoped=!0,this.emit("stop")},o}),o("cofs/fs",["async","buffer","./array2buffer","./promise","./readstream"],function(e,t,n,r,i){"use stricts";var o=t.Buffer,s=null,u=null,f=null,l=function(){this.initialize.apply(this,arguments)};return l.VERSION="0.4.3",l.prototype.initialize=function(e){if(s||(s=window.FileReader||null),u||(u=window.requestFileSystem||window.webkitRequestFileSystem||null),f||(f=window.File||null),!s||!f)throw new Error("Objects of file API does not exists!");this._eventsListeners={},this._fs=null,e=e||{},this._options=e},l.prototype._log=function(){this._options.logger&&this._options.logger.apply({},arguments)},l.prototype._error=function(e){if("object"!=typeof e&&(e=new Error(e)),this._log("CoFS Error"+e.message),!this.emit("error",e))throw e;return e},l.prototype.on=function(e,t,n){"undefined"==typeof this._eventsListeners[e]&&(this._eventsListeners[e]=[]),this._eventsListeners[e].push({cb:t,once:n||!1})},l.prototype.once=function(e,t){return this.on(e,t,!0)},l.prototype.emit=function(){if(!arguments.length)return!1;var e,t=Array.prototype.slice.call(arguments,0),n=t.shift(),r=this._eventsListeners[n]||[];for(this._log("emiting "+n),e=0;e<t.length;e++)r[e]&&(r[e].cb.apply(this,t),r[e].once&&(r[e]=null));return e},l.prototype.getFileSystem=function(e,t){var n=this;return u?("function"==typeof e&&(t=e,e={}),this._log("Open FileSystem",e),void u(window[e.fs||"PERSISTENT"],0,function(e){n._fs=e,t(null,e)},function(e){n._log("Error getting FileSystem",e),n._error(e)})):t(new Error("The browser has not requestFileSystem"))},l.prototype.getDirectory=function(e,t,n){var r=this;"function"==typeof t&&(n=t,t=void 0);var i=!1;t=t||{},this.getFileSystem(function(o,s){s.root.getDirectory(e,t,function(e){return i?void 0:(i=!0,n(void 0,e))},function(e){return i?void 0:(i=!0,r._log("Error getting directory entry",e),r._error(e),n(e))})})},l.prototype.getFileEntry=function(e,t,n){"function"==typeof t&&(n=t,t={});var r=t.root||void 0;if(this._log("Getting FileEntry for",e,t),"object"==typeof e)return n(null,e);var i=this;this.getFileSystem(function(o,s){return o?n(o):("undefined"==typeof r&&(r=s.root),void r.getFile(e,t,function(t){i.emit("fileentry:"+e,t),n(null,t)},function(e){i._log("Error getting FileEntry",e),n(e)}))})},l.prototype.readFromFileObject=function(e,t){var r=this;this._log("Creating filereader object",e);var i=new s;i.onloadend=function(){if(r._log("load end call! with large (relative): ",this.result.length),!this.result)return null;var e=n(this.result);t(null,e)},i.onerror=function(e){r._log("Error Reading file",e),t(new Error("Reading file"))},i.onabort=function(){r._log("Reading file Abort!!"),t(new Error("Reading abort"))},i.readAsArrayBuffer(e)},l.prototype.readFromFileEntry=function(e,t){var n=this;e.file(function(e){n.readFromFileObject(e,t)})},l.prototype.readFile=function(e,t){var n=this;return e instanceof f||e instanceof Blob?this.readFromFileObject(e,t):void this.getFileEntry(e,function(e,r){return e?t(e):void n.readFromFileEntry(r,t)})},l.prototype.writeFile=function(e,t,n,r){var i=this;o.isBuffer(t)?(r=n,n=void 0):t=new o(t,n),this.getFileSystem(function(n){if(n)return r(n);var o={create:!0,exclusive:!0};i.getFileEntry(e,o,function(n,i){return n?r(new Error("Error getting file access "+n.message)):void i.createWriter(function(e){e.onwriteend=function(){r(null)},e.onerror=function(e){r(new Error(e.toString()))};var n=new Blob([t],{type:"application/octet-stream"});e.write(n)},function(){r(new Error("Error writing "+e))})})})},l.prototype.readFilePart=function(e,t,n,r){if("function"!=typeof e.slice)if("function"===e.mozSlice)e.slice=e.mozSlice;else{if("function"!==e.webkitSlice){var i=this._error("File has not slice method");return r(i)}e.slice=e.webkitSlice}return this.readFromFileObject(e.slice(t,n),r)},l.prototype.createReadStream=function(e,t){var n=new i(this,e,t);return n},l}),o("async",function(){return e}),o("buffer",function(){return t}),o("eventemitter2",function(){return n}),i("cofs/fs")});