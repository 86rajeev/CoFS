/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

!function(e,t){if("function"==typeof define&&define.amd)define(["async","buffer","eventemitter2"],t);else{var n=e.CoFS;e.CoFS=t(e.async,e.buffer,e.EventEmitter2),e.CoFS.noConflict=function(){return e.CoFS=n,CoFS}}}(this,function(e,t,n){var i,r,o;return function(e){function t(e,t){return _.call(e,t)}function n(e,t){var n,i,r,o,s,u,f,l,c,a,p,d=t&&t.split("/"),h=v.map,y=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(d=d.slice(0,d.length-1),e=e.split("/"),s=e.length-1,v.nodeIdCompat&&F.test(e[s])&&(e[s]=e[s].replace(F,"")),e=d.concat(e),c=0;c<e.length;c+=1)if(p=e[c],"."===p)e.splice(c,1),c-=1;else if(".."===p){if(1===c&&(".."===e[2]||".."===e[0]))break;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((d||y)&&h){for(n=e.split("/"),c=n.length;c>0;c-=1){if(i=n.slice(0,c).join("/"),d)for(a=d.length;a>0;a-=1)if(r=h[d.slice(0,a).join("/")],r&&(r=r[i])){o=r,u=c;break}if(o)break;!f&&y&&y[i]&&(f=y[i],l=c)}!o&&f&&(o=f,u=l),o&&(n.splice(0,u,o),e=n.join("/"))}return e}function s(t,n){return function(){var i=b.call(arguments,0);return"string"!=typeof i[0]&&1===i.length&&i.push(null),d.apply(e,i.concat([t,n]))}}function u(e){return function(t){return n(t,e)}}function f(e){return function(t){g[e]=t}}function l(n){if(t(m,n)){var i=m[n];delete m[n],w[n]=!0,p.apply(e,i)}if(!t(g,n)&&!t(w,n))throw new Error("No "+n);return g[n]}function c(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function a(e){return function(){return v&&v.config&&v.config[e]||{}}}var p,d,h,y,g={},m={},v={},w={},_=Object.prototype.hasOwnProperty,b=[].slice,F=/\.js$/;h=function(e,t){var i,r=c(e),o=r[0];return e=r[1],o&&(o=n(o,t),i=l(o)),o?e=i&&i.normalize?i.normalize(e,u(t)):n(e,t):(e=n(e,t),r=c(e),o=r[0],e=r[1],o&&(i=l(o))),{f:o?o+"!"+e:e,n:e,pr:o,p:i}},y={require:function(e){return s(e)},exports:function(e){var t=g[e];return"undefined"!=typeof t?t:g[e]={}},module:function(e){return{id:e,uri:"",exports:g[e],config:a(e)}}},p=function(n,i,r,o){var u,c,a,p,d,v,_=[],b=typeof r;if(o=o||n,"undefined"===b||"function"===b){for(i=!i.length&&r.length?["require","exports","module"]:i,d=0;d<i.length;d+=1)if(p=h(i[d],o),c=p.f,"require"===c)_[d]=y.require(n);else if("exports"===c)_[d]=y.exports(n),v=!0;else if("module"===c)u=_[d]=y.module(n);else if(t(g,c)||t(m,c)||t(w,c))_[d]=l(c);else{if(!p.p)throw new Error(n+" missing "+c);p.p.load(p.n,s(o,!0),f(c),{}),_[d]=g[c]}a=r?r.apply(g[n],_):void 0,n&&(u&&u.exports!==e&&u.exports!==g[n]?g[n]=u.exports:a===e&&v||(g[n]=a))}else n&&(g[n]=r)},i=r=d=function(t,n,i,r,o){if("string"==typeof t)return y[t]?y[t](n):l(h(t,n).f);if(!t.splice){if(v=t,v.deps&&d(v.deps,v.callback),!n)return;n.splice?(t=n,n=i,i=null):t=e}return n=n||function(){},"function"==typeof i&&(i=r,r=o),r?p(e,t,n,i):setTimeout(function(){p(e,t,n,i)},4),d},d.config=function(e){return d(e)},i._defined=g,o=function(e,n,i){n.splice||(i=n,n=[]),t(g,e)||t(m,e)||(m[e]=[e,n,i])},o.amd={jQuery:!0}}(),o("node_modules/almond/almond",function(){}),o("cofs/array2buffer",["buffer"],function(e){"use stricts";var t=e.Buffer,n=function(e){var n,i,r,o,s;if(s=new Int8Array(e),o=new t(s),r=e.byteLength,o.length||!r)return s=null,o;for(o=new t(r),n=0;r>n;n++)i=s[n],o.writeUInt8(i,n);return s=null,o};return n}),o("cofs/promise",[],function(){"use stricts";var e=function(e){if("function"!=typeof e)throw new Error("Listener not defined");return function(){var t=Array.prototype.slice.call(arguments);e.apply({},t)}};return e}),o("cofs/readstream",["async","eventemitter2"],function(e,t){"use stricts";var n,i,r=function(){Error.call(this)};r.prototype=new Error;var o=function(){this.initialize.apply(this,arguments)};return o.prototype=new t,o.prototype.initialize=function(e,r,o){if(t.call(this),o=o||{},n=window.File||void 0,i=window.Blob||void 0,"undefined"==typeof n)throw new Error("File componet does not exits");if("undefined"==typeof i)throw new Error("Blob componet does not exists");if(this._fs=e,this._file=r,this._blockSize=o.blockSize||4096,this._start=o.start||0,this._end=void 0!==o.end?o.end:void 0,this._paused=!1,this._stoped=!1,this._end<=this._start)throw new Error("Start byte has been bigger that end byte")},o.prototype._error=function(e){var t=this.emit("error",e);if(!t)throw e},o.prototype.getFile=function(e){var t=this._fs,r=this._file;return r instanceof n||r instanceof i?e(void 0,r):void t.getFileEntry(r,function(t,n){return t?e(t):void n.file(function(t){return e(void 0,t)})})},o.prototype.start=function(){var t=this,n=this._start,i=this._end,o=this._blockSize;this.getFile(function(s,u){if(s)return t._error(s);t.emit("debug","Starting strean for "+u.fullPath),"undefined"==typeof i&&(i=u.size);var f=n;e.whilst(function(){return i>=f},function(e){var n=function(n){return t.emit("debug","Sending data block"),t.emit("data",n),e()};t._fs.readFilePart(u,f,f+o,function(i,s){return f+=o,i?void e(i):t._paused?(t.emit("debug","Is paused, wating resume event to send data"),t.once("resume",function(){t.emit("resumed, sending data"),n(s)})):t._stoped?(t.emit("Is stoped, throwing"),e(new r)):void n(s)})},function(e){return e instanceof r?void 0:e?t._error(e):(t.emit("Finished"),t._paused?(t.emit("Are finished but is paused, waiting."),void t.once("resume",function(){return t.emit("debug","resumed, sending finish"),t.emit("finish")})):(t.emit("Sending finish"),t.emit("finish")))})})},o.prototype.pause=function(){this._paused=!0,this.emit("pause")},o.prototype.resume=function(){this._paused=!1,this.emit("resume")},o.prototype.stop=function(){this._stoped=!0,this.emit("stop")},o}),o("cofs/writestream",["buffer","async","eventemitter2"],function(e,t,n){var i,r,o=e.Buffer,s=function(){Error.call(this)};s.prototype=new Error;var u=function(){this.initialize.apply(this,arguments)};return u.prototype=new n,u.prototype.initialize=function(e,o,s){var u=this;if(n.call(this),s=s||{},i=window.File||void 0,r=window.Blob||void 0,"undefined"==typeof i)throw new Error("File componet does not exits");if("undefined"==typeof r)throw new Error("Blob componet does not exists");this._fs=e,this._file=o,this._start=s.start||0,this._last=0,this._paused=!1,this._stoped=!1,this._writeQueue=t.queue(function(e,t){u._fs.writeFilePart(u._file,e,t)},1),this._writeQueue.drain=function(){u.emit("drain")}},u.prototype._error=function(e){var t=this.emit("error",e);if(!t)throw e},u.prototype.write=function(e,t,n){o.isBuffer(e)?(n=t,t=void 0):e=new o(e,t),n=n||function(){},this._writeQueue.push(e,n)},u.prototype.getFile=function(e){var t=this._fs,n=this._file;return n instanceof i||n instanceof r?e(void 0,n):void t.getFileEntry(n,function(t,n){return t?e(t):void n.file(function(t){return e(void 0,t)})})},u.prototype.resume=function(){this._writeQueue.resume(),this.emit("resume")},u.prototype.pause=function(){this._paused=!0,this._writeQueue.pause(),this.emit("pause")},u.prototype.stop=function(){this._stoped=!0,this._writeQueue.kill(),this.emit("stop")},u}),o("cofs/fs",["async","buffer","./array2buffer","./promise","./readstream","./writestream"],function(e,t,n,i,r,o){"use stricts";var s=t.Buffer,u=null,f=null,l=null,c=function(){this.initialize.apply(this,arguments)};return c.VERSION="0.4.3",c.prototype.initialize=function(e){if(u||(u=window.FileReader||null),f||(f=window.requestFileSystem||window.webkitRequestFileSystem||null),l||(l=window.File||null),!u||!l)throw new Error("Objects of file API does not exists!");this._eventsListeners={},this._fs=null,e=e||{},this._options=e},c.prototype._log=function(){this._options.logger&&this._options.logger.apply({},arguments)},c.prototype._error=function(e){if("object"!=typeof e&&(e=new Error(e)),this._log("CoFS Error"+e.message),!this.emit("error",e))throw e;return e},c.prototype.on=function(e,t,n){"undefined"==typeof this._eventsListeners[e]&&(this._eventsListeners[e]=[]),this._eventsListeners[e].push({cb:t,once:n||!1})},c.prototype.once=function(e,t){return this.on(e,t,!0)},c.prototype.emit=function(){if(!arguments.length)return!1;var e,t=Array.prototype.slice.call(arguments,0),n=t.shift(),i=this._eventsListeners[n]||[];for(this._log("emiting "+n),e=0;e<t.length;e++)i[e]&&(i[e].cb.apply(this,t),i[e].once&&(i[e]=null));return e},c.prototype.getFileSystem=function(e,t){var n=this;return f?("function"==typeof e&&(t=e,e={}),this._log("Open FileSystem",e),void f(window[e.fs||"PERSISTENT"],0,function(e){n._fs=e,t(null,e)},function(e){n._log("Error getting FileSystem",e),n._error(e)})):t(new Error("The browser has not requestFileSystem"))},c.prototype.getDirectory=function(e,t,n){var i=this;"function"==typeof t&&(n=t,t=void 0);var r=!1;t=t||{},this.getFileSystem(function(o,s){s.root.getDirectory(e,t,function(e){return r?void 0:(r=!0,n(void 0,e))},function(e){return r?void 0:(r=!0,i._log("Error getting directory entry",e),i._error(e),n(e))})})},c.prototype.getFileEntry=function(e,t,n){"function"==typeof t&&(n=t,t={});var i=t.root||void 0;if(this._log("Getting FileEntry for",e,t),"object"==typeof e)return n(null,e);var r=this;this.getFileSystem(function(o,s){return o?n(o):("undefined"==typeof i&&(i=s.root),void i.getFile(e,t,function(t){r.emit("fileentry:"+e,t),n(null,t)},function(e){r._log("Error getting FileEntry",e),n(e)}))})},c.prototype.readFromFileObject=function(e,t){var i=this;this._log("Creating filereader object",e);var r=new u;r.onloadend=function(){if(i._log("load end call! with large (relative): ",this.result.length),!this.result)return null;var e=n(this.result);t(null,e)},r.onerror=function(e){i._log("Error Reading file",e),t(new Error("Reading file"))},r.onabort=function(){i._log("Reading file Abort!!"),t(new Error("Reading abort"))},r.readAsArrayBuffer(e)},c.prototype.readFromFileEntry=function(e,t){var n=this;e.file(function(e){n.readFromFileObject(e,t)})},c.prototype.readFile=function(e,t){var n=this;return e instanceof l||e instanceof Blob?this.readFromFileObject(e,t):void this.getFileEntry(e,function(e,i){return e?t(e):void n.readFromFileEntry(i,t)})},c.prototype.writeFile=function(e,t,n,i){var r=this;s.isBuffer(t)?(i=n,n=void 0):t=new s(t,n),this.getFileSystem(function(n){if(n)return i(n);var o={create:!0,exclusive:!0};r.getFileEntry(e,o,function(n,r){return n?i(new Error("Error getting file access "+n.message)):void r.createWriter(function(e){e.onwriteend=function(){i(null)},e.onerror=function(e){i(new Error(e.toString()))};var n=new Blob([t],{type:"application/octet-stream"});e.write(n)},function(){i(new Error("Error writing "+e))})})})},c.prototype.readFilePart=function(e,t,n,i){if("function"!=typeof e.slice)if("function"===e.mozSlice)e.slice=e.mozSlice;else{if("function"!==e.webkitSlice){var r=this._error("File has not slice method");return i(r)}e.slice=e.webkitSlice}return this.readFromFileObject(e.slice(t,n),i)},c.prototype.writeFilePart=function(e,t,n,i,r){var o=this;"number"!=typeof t&&(r=i,i=n,n=t,t=null),s.isBuffer(n)?(r=i,i=void 0):n=new s(n,i),this.getFileSystem(function(i){if(i)return r(i);var s={create:!1,exclusive:!0};o.getFileEntry(e,s,function(i,o){return i?r(new Error("Error getting file access "+i.message)):void o.createWriter(function(e){t||(t=e.length),e.onwriteend=function(){r(null)},e.onerror=function(e){r(new Error(e.toString()))};var i=new Blob([n],{type:"application/octet-stream"});e.seek(t),e.write(i)},function(){r(new Error("Error writing "+e))})})})},c.prototype.createReadStream=function(e,t){var n=new r(this,e,t);return n},c.prototype.createWriteStream=function(e,t){var n=new o(this,e,t);return n},c}),o("async",function(){return e}),o("buffer",function(){return t}),o("eventemitter2",function(){return n}),r("cofs/fs")});