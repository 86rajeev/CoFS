(function(b,c){if(typeof define==="function"&&define.amd){define(["buffer","exports"],function(d,e){return c(b,e,d)})}else{if(typeof exports!=="undefined"){var a=require("buffer");c(b,exports,a)}else{b.cofs=c(b,{},b.buffer)}}})(this,function(b,d,a){var c=b.cofs;var g=a.Buffer;var f=window.FileReader||null;var e=window.requestFileSystem||window.webkitRequestFileSystem||null;if(!f||!e){throw new Error("Objects of file API does not exists!")}d=function(){this.initialize.apply(this,arguments)};d.VERSION="0.1.0";d.noConflict=function(){b.cofs=c;return this};d.prototype.initialize=function(i){var h=this;this._eventsListeners={};this._loaded=false;this._fs=null;i=i||{};e(window[i.fs||"PERSISTENT"],0,function(j){h._loaded=true;h._fs=j;h.emit("ready",j)},function(j){h._loaded=false;h._error(j)})};d.prototype._ifready=function(h){if(this._loaded){h(this._fs)}else{this.once("ready",h)}};d.prototype._error=function(h){if(typeof h!=="object"){h=new Error(h)}if(!this.emit("error",h)){throw h}};d.prototype.on=function(h,j,i){if(typeof this._eventsListeners[h]==="undefined"){this._eventsListeners[h]=[]}this._eventsListeners[h].push({cb:j,once:i||false})};d.prototype.once=function(h,i){return this.on(h,i,true)};d.prototype.emit=function(){if(!arguments.length){return false}var j=Array.prototype.slice.call(arguments,0);var h=j.shift();var l=this._eventsListeners[h]||[];var k;console.log("emiting "+h);for(k=0;k<j.length;k++){if(!l[k]){continue}l[k].cb.apply(b,j);if(l[k].once){l[k]=null}}return k};d.prototype.getFileEntry=function(k,i,j){if(typeof i==="function"){j=i;i={}}if(typeof k==="object"){return j(null,k)}var h=this;this._ifready(function(){console.log("Getting fileentry for "+k);h._fs.root.getFile(k,i,function(l){h.emit("fileentry:"+k,l);j(null,l)},function(l){j(l)})})};d.prototype.readFile=function(i,j){var h=this;this._ifready(function(){console.log("Reading",i);var k=new f();k.onloadend=function(m){var l=this.result;console.log("loaded:",this.result);if(!l){return null}var n=l.replace(/^data:[^;]*;base64,/i,"");j(null,new g(n,"base64"))};k.onerror=function(l){j(new Error("Reading file"))};k.onabort=function(l){j(new Error("Reading abort"))};k.readAsDataURL(i)})};return d});