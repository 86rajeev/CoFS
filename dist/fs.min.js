(function(b,c){if(typeof define==="function"&&define.amd){define(["buffer","exports"],function(d,f){return c(b,f,d)})}else{if(typeof exports!=="undefined"){var a=require("buffer");c(b,exports,a)}else{b.cofs=c(b,{},b.buffer)}}})(this,function(b,d,a){var c=b.cofs;var h=a.Buffer;var g=window.FileReader||null;var f=window.requestFileSystem||window.webkitRequestFileSystem||null;if(!g||!f){throw new Error("Objects of file API does not exists!")}d=function(){this.initialize.apply(this,arguments)};d.VERSION="0.1.0";d.noConflict=function(){b.cofs=c;return this};d.prototype.initialize=function(j){var i=this;this._eventsListeners={};this._loaded=false;this._fs=null;j=j||{};f(window[j.fs||"PERSISTENT"],0,function(k){i._loaded=true;i._fs=k;i.emit("ready",k)},function(k){i._loaded=false;i._error(k)})};d.prototype._ifready=function(i){if(this._loaded){i(this._fs)}else{this.once("ready",i)}};d.prototype._error=function(i){if(typeof i!=="object"){i=new Error(i)}console.log("CoFS Error"+e.message);if(!this.emit("error",i)){throw i}};d.prototype.on=function(i,k,j){if(typeof this._eventsListeners[i]==="undefined"){this._eventsListeners[i]=[]}this._eventsListeners[i].push({cb:k,once:j||false})};d.prototype.once=function(i,j){return this.on(i,j,true)};d.prototype.emit=function(){if(!arguments.length){return false}var k=Array.prototype.slice.call(arguments,0);var j=k.shift();var m=this._eventsListeners[j]||[];var l;console.log("emiting "+j);for(l=0;l<k.length;l++){if(!m[l]){continue}m[l].cb.apply(b,k);if(m[l].once){m[l]=null}}return l};d.prototype.getFileEntry=function(l,j,k){if(typeof j==="function"){k=j;j={}}if(typeof l==="object"){return k(null,l)}var i=this;this._ifready(function(){console.log("Getting fileentry for "+l);i._fs.root.getFile(l,j,function(m){i.emit("fileentry:"+l,m);k(null,m)},function(m){k(m)})})};d.prototype.readFile=function(k,j){var i=this;this._ifready(function(){i.getFileEntry(k,function(n,m){if(n){return j(n)}console.log("Reading "+k);var l=new g();l.onloadend=function(p){var o=this.result;console.log("loaded:",this.result);if(!o){return null}var q=o.replace(/^data:[^;]*;base64,/i,"");j(null,new h(q,"base64"))};l.onerror=function(o){j(new Error("Reading file"))};l.onabort=function(o){j(new Error("Reading abort"))};l.readAsDataURL(m)})})};d.prototype.writeFile=function(l,j,k){var i=this;if(h.isBuffer(j)){j=j.toString("binary")}this._ifready(function(){i.getFileEntry(l,{create:true,exclusive:true},function(m,n){if(m){return k(new Error("Error getting file access "+m.message))}n.createWriter(function(p){p.onwriteend=function(){k(null)};p.onerror=function(q){k(new Error(q.toString()))};var o=new Blob([j],{type:"application/octet-stream"});p.write(o)},function(){k(new Error("Error writing "+l))})})})};return d});