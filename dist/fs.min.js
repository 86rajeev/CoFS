(function(b,c){if(typeof define==="function"&&define.amd){define(["buffer","exports"],function(d,f){return c(b,f,d)})}else{if(typeof exports!=="undefined"){var a=require("buffer");c(b,exports,a)}else{b.cofs=c(b,{},b.buffer)}}})(this,function(b,d,a){var c=b.cofs;var h=a.Buffer;var g=window.FileReader||null;var f=window.requestFileSystem||window.webkitRequestFileSystem||null;if(!g||!f){throw new Error("Objects of file API does not exists!")}d=function(){this.initialize.apply(this,arguments)};d.VERSION="0.1.0";d.noConflict=function(){b.cofs=c;return this};d.prototype.initialize=function(j){var i=this;this._eventsListeners={};this._fs=null;j=j||{};this._options=j};d.prototype._log=function(){if(this._options.logger){this._options.logger.apply({},arguments)}};d.prototype._error=function(i){if(typeof i!=="object"){i=new Error(i)}this._log("CoFS Error"+e.message);if(!this.emit("error",i)){throw i}};d.prototype.on=function(i,k,j){if(typeof this._eventsListeners[i]==="undefined"){this._eventsListeners[i]=[]}this._eventsListeners[i].push({cb:k,once:j||false})};d.prototype.once=function(i,j){return this.on(i,j,true)};d.prototype.emit=function(){if(!arguments.length){return false}var k=Array.prototype.slice.call(arguments,0);var j=k.shift();var m=this._eventsListeners[j]||[];var l;this._log("emiting "+j);for(l=0;l<k.length;l++){if(!m[l]){continue}m[l].cb.apply(b,k);if(m[l].once){m[l]=null}}return l};d.prototype.getFileSystem=function(j,k){var i=this;if(typeof j=="function"){k=j;j={}}this._log("Open FileSystem",j);f(window[j.fs||"PERSISTENT"],0,function(l){i._fs=l;k(null,l)},function(l){i._log("Error getting FileSystem",l);i._error(l)})};d.prototype.getFileEntry=function(l,j,k){if(typeof j==="function"){k=j;j={}}this._log("Getting FileEntry for",l,j);if(typeof l==="object"){return k(null,l)}var i=this;this.getFileSystem(function(n,m){if(n){return k(n)}m.root.getFile(l,j,function(o){i.emit("fileentry:"+l,o);k(null,o)},function(o){i._log("Error getting FileEntry",o);k(o)})})};d.prototype.readFile=function(k,j){var i=this;this._log("Reading file for",k);i.getFileEntry(k,function(l,m){if(l){i._log("Error getting FileEntry:",l);return j(l)}m.file(function(o){i._log("Creating filereader object",o);var n=new g();n.onloadend=function(q){i._log("reading end",q);var p=this.result;i._log("load end call! with large (relative): ",p.length);if(!p){return null}var r=p.replace(/^data:(?:[^;]*;)?base64,/i,"");i._log(p,r);var s=new h(r,"base64");i._log("New large: ",s.length);j(null,s)};n.onerror=function(p){i._log("Error Reading file",p);j(new Error("Reading file"))};n.onabort=function(p){i._log("Reading file Abort!!");j(new Error("Reading abort"))};i._log("read as url!");n.readAsDataURL(o)})})};d.prototype.writeFile=function(l,j,k){var i=this;if(h.isBuffer(j)){j=j.toString("binary")}this._ifready(function(){i.getFileEntry(l,{create:true,exclusive:true},function(m,n){if(m){return k(new Error("Error getting file access "+m.message))}n.createWriter(function(p){p.onwriteend=function(){k(null)};p.onerror=function(q){k(new Error(q.toString()))};var o=new Blob([j],{type:"application/octet-stream"});p.write(o)},function(){k(new Error("Error writing "+l))})})})};return d});